name: Textbook Scheduler

on:
  schedule:
    # 1. 03:30 UTC - Theory (Part 1)
    - cron: '30 3 * * *'
    # 2. 07:30 UTC - Practice (Part 2)
    - cron: '30 7 * * *'
    # 3. 11:00 UTC - Mentor (Part 3)
    - cron: '0 11 * * *'
    # 4. 13:00 UTC - Batch Easy
    - cron: '0 13 * * *'
    # 5. 16:00 UTC - Batch Medium
    - cron: '0 16 * * *'
    # 6. 19:00 UTC - Batch Hard
    - cron: '0 19 * * *'

  workflow_dispatch:
    inputs:
      day:
        description: 'Day to generate (number or "auto")'
        required: true
        default: 'auto'
      part:
        description: 'Part to generate'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - part1
        - part2
        - part3
        - batch_easy
        - batch_medium
        - batch_hard

jobs:
  generate-textbook:
    runs-on: ubuntu-latest
    
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v2

      - name: Setup Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Determine Run Scope
        id: scope
        shell: python
        run: |
          import os
          import datetime
          import sys
          
          event_name = "${{ github.event_name }}"
          manual_day = "${{ github.event.inputs.day }}"
          manual_part = "${{ github.event.inputs.part }}"
          
          day = "auto"
          part = ""
          
          if event_name == "workflow_dispatch":
              print(f"ðŸ‘‹ Manual Trigger Detected.")
              day = manual_day
              part = manual_part
              
          elif event_name == "schedule":
              now = datetime.datetime.utcnow()
              hour = now.hour
              print(f"ðŸ•’ Schedule Trigger. UTC Hour: {hour}")
              
              # Map Hour to Part (Allowing variance)
              if 3 <= hour <= 6:
                  part = "part1"        # 03:30 - Theory (Allow 3h delay)
              elif 7 <= hour <= 10:
                  part = "part2"        # 07:30 - Practice
              elif 11 <= hour <= 12:
                  part = "part3"        # 11:00 - Mentor (Gap is tighter here)
              elif 13 <= hour <= 15:
                  part = "batch_easy"   # 13:00 - Q35 Easy
              elif 16 <= hour <= 18:
                  part = "batch_medium" # 16:00 - Q35 Medium
              elif 19 <= hour <= 23:
                  part = "batch_hard"   # 19:00 - Q35 Hard
          
          if not part:
              print("âŒ Could not determine part from time.")
              sys.exit(1)
              
          print(f"âœ… Selected Day: {day}")
          print(f"âœ… Selected Part: {part}")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"day={day}\n")
              f.write(f"part={part}\n")

      - name: Run Textbook Generator
        run: |
          echo "ðŸš€ Launching Bot... Day: ${{ steps.scope.outputs.day }}, Part: ${{ steps.scope.outputs.part }}"
          python run_textbook_bot.py --day ${{ steps.scope.outputs.day }} --part ${{ steps.scope.outputs.part }}
