name: Textbook Content Generator

on:
  schedule:
    # 1. Part 1 (Theory): 16:30 UTC (2 hours after PyDaily Evening email)
    - cron: '30 16 * * *'
    # 2. Part 2 (Practice): 17:30 UTC
    - cron: '30 17 * * *'
    # 3. Part 3 (Mentor): 18:30 UTC
    - cron: '30 18 * * *'
    # 4. Weekly Summary: 19:30 UTC (Saturday)
    - cron: '30 19 * * 6'
  workflow_dispatch:
    inputs:
      action:
        description: Choose what to generate
        required: true
        default: all
        type: choice
        options:
          - all
          - part1
          - part2
          - part3
          - weekly
          - final
      day:
        description: Day number (1-179)
        required: false
        default: '1'
        type: string

jobs:
  generate-content:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc wkhtmltopdf

      - name: Run Generator
        shell: python
        run: |
          import os
          import datetime
          
          # Get inputs from environment variables (set by GitHub Actions)
          event_name = os.getenv("GITHUB_EVENT_NAME")
          
          mode = "all"
          day = "1"
          
          # GitHub context access via templating in the python script string
          # We pass these as args to avoid syntax issues
          raw_action = "${{ github.event.inputs.action }}"
          raw_day = "${{ github.event.inputs.day }}"
          
          if event_name == "workflow_dispatch":
              mode = raw_action if raw_action else "all"
              day = raw_day if raw_day else "1"
          
          elif event_name == "schedule":
              now = datetime.datetime.utcnow()
              hour = now.hour
              print(f"Schedule Trigger. UTC Hour: {hour}")
              
              # New Schedule Logic: 16:30, 17:30, 18:30, 19:30
              if 16 <= hour < 17:
                  mode = "part1"  # 16:30 UTC
              elif 17 <= hour < 18:
                  mode = "part2"  # 17:30 UTC
              elif 18 <= hour < 19:
                  mode = "part3"  # 18:30 UTC
              elif hour >= 19:
                  mode = "weekly" # 19:30 UTC
              
              day = "auto"
          
          print(f"Running generator with Mode: {mode}, Day: {day}")
          
          import subprocess
          
          cmd = ["python", "run_textbook_bot.py"]
          
          if mode == "weekly":
              cmd.extend(["--weekly", "1"])
          elif mode == "final":
              cmd.extend(["--final"])
          elif mode == "all":
              cmd.extend(["--day", day, "--part", "all"])
          else:
              cmd.extend(["--day", day, "--part", mode])
              
          subprocess.run(cmd, check=True)
