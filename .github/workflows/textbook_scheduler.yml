name: Textbook Content Generator

on:
  schedule:
    - cron: '30 2 * * *'
    - cron: '30 4 * * *'
    - cron: '30 6 * * *'
    - cron: '30 8 * * 6'
  workflow_dispatch:
    inputs:
      action:
        description: Choose what to generate
        required: true
        default: all
        type: choice
        options:
          - all
          - part1
          - part2
          - part3
          - weekly
          - final
      day:
        description: Day number (1-179)
        required: false
        default: '1'
        type: string

jobs:
  generate-content:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Install Pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc wkhtmltopdf

      - name: Run Generator
        shell: python
        run: |
          import os
          import datetime
          
          # Get inputs from environment variables (set by GitHub Actions)
          event_name = os.getenv("GITHUB_EVENT_NAME")
          # Inputs are passed as environment variables by mapped 'env' context or obscure github context
          # Easier way: check event payload or just default if inputs missing
          
          # We'll use the arguments directly in the command execution for simplicity
          # But we need to construct the command
          
          mode = "all"
          day = "1"
          
          # GitHub context access via templating in the python script string
          # We pass these as args to avoid syntax issues
          raw_action = "${{ github.event.inputs.action }}"
          raw_day = "${{ github.event.inputs.day }}"
          
          if event_name == "workflow_dispatch":
              mode = raw_action if raw_action else "all"
              day = raw_day if raw_day else "1"
          
          elif event_name == "schedule":
              now = datetime.datetime.utcnow()
              hour = now.hour
              print(f"Schedule Trigger. UTC Hour: {hour}")
              
              if 2 <= hour < 4:
                  mode = "part1"  # 02:30 UTC
              elif 4 <= hour < 6:
                  mode = "part2"  # 04:30 UTC
              elif 6 <= hour < 8:
                  mode = "part3"  # 06:30 UTC
              elif hour >= 8:
                  mode = "weekly" # 08:30 UTC
              
              day = "auto"
          
          print(f"Running generator with Mode: {mode}, Day: {day}")
          
          import subprocess
          
          cmd = ["python", "run_textbook_bot.py"]
          
          if mode == "weekly":
              cmd.extend(["--weekly", "1"])
          elif mode == "final":
              cmd.extend(["--final"])
          elif mode == "all":
              cmd.extend(["--day", day, "--part", "all"])
          else:
              cmd.extend(["--day", day, "--part", mode])
              
          subprocess.run(cmd, check=True)
