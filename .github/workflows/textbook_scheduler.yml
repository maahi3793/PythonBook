name: PythonBook Textbook Scheduler

on:
  schedule:
    # Schedule (UTC) -> IST (+5:30)
    # 17:30 UTC -> 11:00 PM IST (Daily Full Generation)
    - cron: '30 17 * * *'

  workflow_dispatch:
    inputs:
      day:
        description: 'Day to generate (number or "auto")'
        required: true
        default: 'auto'
      part:
        description: 'Part to generate (part1, part2, part3, summary, all)'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - part1
        - part2
        - part3
        - summary

jobs:
  generate-textbook:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      - name: Determine Run Scope
        id: scope
        shell: bash
        run: |
          # Default to Inputs if manual, else defaults
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            DAY="${{ github.event.inputs.day }}"
            PART="${{ github.event.inputs.part }}"
            echo "ðŸ‘‹ Manual Trigger Detected."
          else
            DAY="auto"
            PART="all"
            echo "ðŸ•’ Schedule Trigger Detected. Defaults: Day=Auto, Part=All"
          fi

          echo "âœ… Selected Day: $DAY"
          echo "âœ… Selected Part: $PART"
          
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "part=$PART" >> $GITHUB_OUTPUT

      - name: Run Textbook Generator
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "ðŸš€ Launching Bot... Day: ${{ steps.scope.outputs.day }}, Part: ${{ steps.scope.outputs.part }}"
          python run_textbook_bot.py --day ${{ steps.scope.outputs.day }} --part ${{ steps.scope.outputs.part }}
          # Force Workflow Refresh v1
